<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="2YO"><title>基于块随机置乱的图像加解密 · 2YO's BLOG</title><meta name="description" content="起因前几天群友在群里发了这么一张图片：敏锐的我在头脑中拼凑了一番发现事情并不一般，之后群里纷纷批评指责这位群友，该群友随后分享了一款APP，诸群友啧啧称奇，满意的笑了，之后就是一波分享会。不过我对这款APP的工作原理产生了兴趣，首先反编译了APP，不过可读性不是很好，功力不够看不太懂，之后去搜了一下"><meta name="keywords" content="热爱,生活,技术,分享,2YO"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style-dark.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 4.0.0"><link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><div id="stage" class="container"><div class="row"><div id="side-bar" class="col-sm-3 col-xs-12 side-container invisible"><div class="vertical-text site-title"><h3 tabindex="-1" class="site-title-small"><a href="/" class="a-title">因为热爱，所以坚持</a></h3><h1 tabindex="-1" class="site-title-large"><a href="/" class="a-title">2YO's BLOG</a></h1><!--h6(onclick="triggerSiteNav()") Trigger--></div><br class="visible-lg visible-md visible-sm"><div id="site-nav" class="site-title-links"><ul><li><a href="/">HOME</a></li><li><a href="/archives">ARCHIVE</a></li><li><a href="/tags">TAGS</a></li><li> <a href="https://www.cnblogs.com/Pretty9/" target="_blank">CNBLOG</a></li><li><a href="/about/index.html">ABOUT</a></li><li><a href="/friends/index.html">FRIENDS</a></li><li><a href="/music/index.html">MUSIC</a></li><li class="soc"><a href="https://github.com/Pretty9" target="_blank" rel="noopener noreferrer"><i class="fa fa-github">&nbsp;</i></a><a href="https://2yo.cc/atom.xml" target="_blank" rel="noopener noreferrer"><i class="fa fa-rss">&nbsp;</i></a></li></ul><div class="visible-lg visible-md visible-sm site-nav-footer"><br class="site-nav-footer-br"><footer><p>&copy;&nbsp;2020&nbsp;<a target="_blank" href="https://2yo.cc" rel="noopener noreferrer">2YO</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p><p><script type="text/javascript" src="https://v1.cnzz.com/z_stat.php?id=1278669758&web_id=1278669758"></script></p></footer></div></div></div><div id="main-container" class="col-sm-9 col-xs-12 main-container invisible"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post-container"><p class="post-title"><a>基于块随机置乱的图像加解密</a></p><p class="post-meta"><span class="date meta-item">Posted at&nbsp;2020-03-19</span><span class="meta-item"><i class="fa fa-tag"></i><span>&nbsp;</span><a href="/tags/tools/" title="tools" class="a-tag">tools</a><span>&nbsp;</span></span></p><p class="post-abstract"><h3 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h3><p>前几天群友在群里发了这么一张图片：<br><img src="./images/1.png" alt="1.png"><br>敏锐的我在头脑中拼凑了一番发现事情并不一般，之后群里纷纷批评指责这位群友，该群友随后分享了一款<a href="https://www.coolapk.com/apk/com.xyznh.imgencryption" target="_blank" rel="noopener">APP</a>，诸群友啧啧称奇，满意的笑了，之后就是一波分享会。不过我对这款APP的工作原理产生了兴趣，首先反编译了APP，不过可读性不是很好，功力不够看不太懂，之后去搜了一下，发现了这么一篇文章<a href="https://blog.csdn.net/xfgryujk/article/details/81058247" target="_blank" rel="noopener">写一个微博上传图片自动加密解密工具</a>，文章中只介绍了像素随机置乱的方法，不过在文章作者的GitHUB上实现了块随机置乱的方法。并且自己实现了一个小工具：<a href="https://2yo.cc/Tools/crypto/">基于块随机置乱的图像加解密</a></p>
<h3 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h3><h4 id="随机数生成"><a href="#随机数生成" class="headerlink" title="随机数生成"></a>随机数生成</h4><p>文章作者实现的功能是微博图片的自动加解密，这里只研究涉及图片加解密的部分。我们知道随机数生成算法生成的并不是真正的随机数，而是一个伪随机数序列，当随机数种子一致时，可以生成相同的伪随机数序列。那么将将图像划分为若干个小块，按照伪随机数序列将这些小块打乱顺序，也就是加密的原理，由于相同的种子可以生成相同的伪随机数序列，那么解密时按照伪随机数序列还原这些小块的顺序就可以了。由于JS自带的Math.random()并不能自己设置随机数种子，因此文章作者把V8引擎中的随机数算法抄了过来：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// 从谷歌V8引擎抄来的 https://github.com/v8/v8/blob/dae6dfe08ba9810abbe7eee81f7c58e999ae8525/src/math.js#L144</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Random</span> <span class="token punctuation">{</span>
  constructor <span class="token punctuation">(</span>seed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_setRngstate</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// seed可以是字符串</span>
  _setRngstate <span class="token punctuation">(</span>seed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// JS真没有好判断字符串是数字的办法</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/^-?\d{1,10}$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> seed <span class="token operator">>=</span> <span class="token operator">-</span><span class="token number">0x80000000</span> <span class="token operator">&amp;&amp;</span> seed <span class="token operator">&lt;=</span> <span class="token number">0x7FFFFFFF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      seed <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      seed <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_hashCode</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_rngstate <span class="token operator">=</span> <span class="token punctuation">[</span>seed <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">,</span> seed <span class="token operator">></span><span class="token operator">></span><span class="token operator">></span> <span class="token number">16</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 抄Java的</span>
  _hashCode <span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> hash <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment" spellcheck="true">// JS的字符串是UTF-16编码</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> str<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      hash <span class="token operator">=</span> <span class="token punctuation">(</span>hash <span class="token operator">*</span> <span class="token number">31</span> <span class="token operator">+</span> str<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFF</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> hash
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 返回[0, 1)</span>
  random <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> r0 <span class="token operator">=</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">imul</span><span class="token punctuation">(</span><span class="token number">18030</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rngstate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_rngstate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">></span><span class="token operator">></span><span class="token operator">></span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_rngstate<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> r0
    <span class="token keyword">let</span> r1 <span class="token operator">=</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">imul</span><span class="token punctuation">(</span><span class="token number">36969</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rngstate<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_rngstate<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">></span><span class="token operator">></span><span class="token operator">></span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_rngstate<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> r1
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r0 <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>r1 <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span>
    <span class="token comment" spellcheck="true">// Division by 0x100000000 through multiplication by reciprocal.</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">0x100000000</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> x<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2.3283064365386962890625e-10</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 返回[min, max]的整数</span>
  randint <span class="token punctuation">(</span>min<span class="token punctuation">,</span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>min <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>max <span class="token operator">-</span> min <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在Java中String类的hashCode()方法的算法如下：<br><img src="./images/2.png" alt="2.png"><br>可以看到这个式子的时间复杂度大致为O(a^n)，可以通过多项式的方式化简：<br><img src="./images/3.png" alt="3.png"><br>这样复杂度就降到了O(n)，31是质数，可以使分布较为均匀。读JDK的源码，可看到hashCode()的源码如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> h <span class="token operator">=</span> hash<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> val<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>

       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> value<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            h <span class="token operator">=</span> <span class="token number">31</span> <span class="token operator">*</span> h <span class="token operator">+</span> val<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        hash <span class="token operator">=</span> h<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> h<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中hash是一个私有实例字段，表示字符串的hash，value就是字符串，java中int类型是32位，通过自然溢出达到取模的效果。注意到javascript和java整形的取值范围不同，在java中可通过Integer.MAX_VALUE和Integer.MIN_VALUE获取最大最小值，分别为2147483647和-2147483648，在javascript中可通过Number.MAX_SAFE_INTEGER和Number.MIN_SAFE_INTEGER获取最大最小值，分别为9007199254740991和-9007199254740991，因此在javascript中不能直接照抄java的代码，这就是位与0xFFFFFFFF的含义，丢弃高位，保留低32位，另外在java中字符串gdejicbegh和hgebcijedg有相同的hash值-801038016，并且他们具有reverse的关系。</p>
<h4 id="洗牌算法的实现"><a href="#洗牌算法的实现" class="headerlink" title="洗牌算法的实现"></a>洗牌算法的实现</h4><p>顾名思义，洗牌算法就是将数组中的元素打乱，打乱之后我们就得到了一个不重复的随机序列。</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// 生成[0, length)的随机序列，每次调用next()返回和之前不重复的值，直到[0, length)用完</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">RandomSequence</span> <span class="token punctuation">{</span>
  constructor <span class="token punctuation">(</span>length<span class="token punctuation">,</span> seed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_rng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_nextMin <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>

  next <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_nextMin <span class="token operator">>=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_list<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_nextMin <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rng<span class="token punctuation">.</span><span class="token function">randint</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_nextMin<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_list<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_list<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_list<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_list<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>_nextMin<span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_list<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>_nextMin<span class="token punctuation">]</span> <span class="token operator">=</span> result
    <span class="token keyword">this</span><span class="token punctuation">.</span>_nextMin<span class="token operator">++</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这段代码十分巧妙，果然读大佬的代码都是赏心悦目，算法的思想是先生成一个元素为从0到length的数组，生成_nextMin到length-1之间的随机数index，之后每次将下标为_nextMin和index的两个元素交换，时间复杂度为O(n)，有些人可能会问：为什么搞这么复杂，直接生成随机数，然后判重，若重复了再生成，直到凑够length个元素不行吗？这样由于每次要判重，复杂度肯定是大于O(n)的。</p>
<h3 id="加密算法的实现"><a href="#加密算法的实现" class="headerlink" title="加密算法的实现"></a>加密算法的实现</h3><p>这段代码最关键的部分就是将JPEG图片分为8X8小块，是由于JPEG是在8x8小块中压缩图像的，至于为什么是8x8，查了一下资料，有以下两条原因，可能不太准确：</p>
<p>1.任何尺寸大于8 X 8的矩阵更难以进行数学运算（如变换等）不支持硬件或需要更长的时间。</p>
<p>2.任何大小小于8 X 8的矩阵都没有足够的信息来与管道一起继续。</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Codec</span> <span class="token punctuation">{</span>
  constructor <span class="token punctuation">(</span>imgData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_imgData <span class="token operator">=</span> imgData
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">// 加密，返回加密后的imgData</span>
  encrypt <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">// 解密，返回解密后的imgData</span>
  decrypt <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// 块随机置乱</span>
<span class="token comment" spellcheck="true">// 由于JPEG是分成8x8的块在块内压缩，分成8x8块处理可以避免压缩再解密造成的高频噪声</span>
<span class="token keyword">class</span> <span class="token class-name">ShuffleBlockCodec</span> <span class="token keyword">extends</span> <span class="token class-name">Codec</span> <span class="token punctuation">{</span>
  encrypt <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_doCommon</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> blockX<span class="token punctuation">,</span> blockY<span class="token punctuation">,</span> newBlockX<span class="token punctuation">,</span> newBlockY<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_copyBlock</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> newBlockX<span class="token punctuation">,</span> newBlockY<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_imgData<span class="token punctuation">,</span> blockX<span class="token punctuation">,</span> blockY<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  decrypt <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_doCommon</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> blockX<span class="token punctuation">,</span> blockY<span class="token punctuation">,</span> newBlockX<span class="token punctuation">,</span> newBlockY<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_copyBlock</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> blockX<span class="token punctuation">,</span> blockY<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_imgData<span class="token punctuation">,</span> newBlockX<span class="token punctuation">,</span> newBlockY<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  _doCommon <span class="token punctuation">(</span>handleCopy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 尺寸不是8的倍数则去掉边界</span>
    <span class="token keyword">let</span> blockWidth <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_imgData<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> blockHeight <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_imgData<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">createImageData</span><span class="token punctuation">(</span>blockWidth <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> blockHeight <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> seq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomSequence</span><span class="token punctuation">(</span>blockWidth <span class="token operator">*</span> blockHeight<span class="token punctuation">,</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>randomSeed<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> blockY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> blockY <span class="token operator">&lt;</span> blockHeight<span class="token punctuation">;</span> blockY<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> blockX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> blockX <span class="token operator">&lt;</span> blockWidth<span class="token punctuation">;</span> blockX<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> index <span class="token operator">=</span> seq<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> newBlockX <span class="token operator">=</span> index <span class="token operator">%</span> blockWidth
        <span class="token keyword">let</span> newBlockY <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>index <span class="token operator">/</span> blockWidth<span class="token punctuation">)</span>
        <span class="token function">handleCopy</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> blockX<span class="token punctuation">,</span> blockY<span class="token punctuation">,</span> newBlockX<span class="token punctuation">,</span> newBlockY<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span>

  _copyBlock <span class="token punctuation">(</span>dstImgData<span class="token punctuation">,</span> dstBlockX<span class="token punctuation">,</span> dstBlockY<span class="token punctuation">,</span> srcImgData<span class="token punctuation">,</span> srcBlockX<span class="token punctuation">,</span> srcBlockY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> iDstStart <span class="token operator">=</span> <span class="token punctuation">(</span>dstBlockY <span class="token operator">*</span> dstImgData<span class="token punctuation">.</span>width <span class="token operator">+</span> dstBlockX<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">4</span>
    <span class="token keyword">let</span> iSrcStart <span class="token operator">=</span> <span class="token punctuation">(</span>srcBlockY <span class="token operator">*</span> srcImgData<span class="token punctuation">.</span>width <span class="token operator">+</span> srcBlockX<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">4</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dstImgData<span class="token punctuation">.</span>data<span class="token punctuation">[</span>iDstStart <span class="token operator">+</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> srcImgData<span class="token punctuation">.</span>data<span class="token punctuation">[</span>iSrcStart <span class="token operator">+</span> i<span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
      iDstStart <span class="token operator">+</span><span class="token operator">=</span> dstImgData<span class="token punctuation">.</span>width <span class="token operator">*</span> <span class="token number">4</span>
      iSrcStart <span class="token operator">+</span><span class="token operator">=</span> srcImgData<span class="token punctuation">.</span>width <span class="token operator">*</span> <span class="token number">4</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="写个小工具"><a href="#写个小工具" class="headerlink" title="写个小工具"></a>写个小工具</h3><p>由于文章作者很好的封装了ShuffleBlockCodec，所以我们直接调用就可以了，代码如下：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">import</span> ShuffleBlockCodec <span class="token keyword">from</span> <span class="token string">'./codec'</span><span class="token punctuation">;</span>


<span class="token keyword">let</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'crypto-canvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> context <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> fileInput <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'crypto-file'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> theSeed <span class="token operator">=</span> <span class="token string">'2020'</span><span class="token punctuation">;</span>


fileInput<span class="token punctuation">.</span>onchange <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> file <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 如果文件undefined</span>
    <span class="token keyword">let</span> bar <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'crypto-bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    bar<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 清空工具栏</span>
    context<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 清空画布</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  reader<span class="token punctuation">.</span><span class="token function">readAsDataURL</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 将File对象转为DataURL</span>
  reader<span class="token punctuation">.</span>onload <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    image<span class="token punctuation">.</span>src <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  image<span class="token punctuation">.</span>onload <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>image<span class="token punctuation">.</span>width<span class="token punctuation">,</span> image<span class="token punctuation">.</span>height<span class="token punctuation">]</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 在画布绘制图像</span>
    <span class="token function">appendButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">appendButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> bar <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'crypto-bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bar<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> enBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  enBtn<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">"加密"</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> deBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  deBtn<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">"解密"</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> seedField <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  seedField<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  seedField<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'placeholder'</span><span class="token punctuation">,</span> <span class="token string">'Seed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> dlBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dlBtn<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">"下载"</span><span class="token punctuation">;</span>

  bar<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>seedField<span class="token punctuation">)</span><span class="token punctuation">;</span>
  bar<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>enBtn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  bar<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>deBtn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  bar<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>dlBtn<span class="token punctuation">)</span><span class="token punctuation">;</span>

  enBtn<span class="token punctuation">.</span>onclick <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> imageData <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getImageData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    theSeed <span class="token operator">=</span> seedField<span class="token punctuation">.</span>value<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> seedField<span class="token punctuation">.</span>value <span class="token punctuation">:</span> <span class="token string">'2020'</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'加密种子:'</span> <span class="token operator">+</span> theSeed<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> codec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShuffleBlockCodec</span><span class="token punctuation">(</span>imageData<span class="token punctuation">,</span> theSeed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">putImageData</span><span class="token punctuation">(</span>codec<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  deBtn<span class="token punctuation">.</span>onclick <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> imageData <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getImageData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    theSeed <span class="token operator">=</span> seedField<span class="token punctuation">.</span>value<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> seedField<span class="token punctuation">.</span>value <span class="token punctuation">:</span> <span class="token string">'2020'</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'解密种子:'</span> <span class="token operator">+</span> theSeed<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> codec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShuffleBlockCodec</span><span class="token punctuation">(</span>imageData<span class="token punctuation">,</span> theSeed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">putImageData</span><span class="token punctuation">(</span>codec<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  dlBtn<span class="token punctuation">.</span>onclick <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> fileName <span class="token operator">=</span> <span class="token function">encodeURI</span><span class="token punctuation">(</span>theSeed<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.jpg'</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 将seed进行URI编码，防止非法字符</span>
    <span class="token function">exportCanvasAsPNG</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 保存为jpg</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">exportCanvasAsPNG</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">let</span> MIME_TYPE <span class="token operator">=</span> <span class="token string">"image/jpg"</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> imgURL <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span>MIME_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> dlLink <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dlLink<span class="token punctuation">.</span>download <span class="token operator">=</span> fileName<span class="token punctuation">;</span>
  dlLink<span class="token punctuation">.</span>href <span class="token operator">=</span> imgURL<span class="token punctuation">;</span>
  dlLink<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>downloadurl <span class="token operator">=</span> <span class="token punctuation">[</span>MIME_TYPE<span class="token punctuation">,</span> dlLink<span class="token punctuation">.</span>download<span class="token punctuation">,</span> dlLink<span class="token punctuation">.</span>href<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>dlLink<span class="token punctuation">)</span><span class="token punctuation">;</span>
  dlLink<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>dlLink<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以自定义随机数种子，效果如下所示：<br><img src="./images/4.png" alt="4.png"> <img src="./images/5.png" alt="5.png"></p>
<p>工具地址：<a href="https://2yo.cc/Tools/crypto/">基于块随机置乱的图像加解密</a></p>
<p>一开始我用C++实现了一个像素随机置乱的程序，发现解密之后噪声太严重了，根本不能用。C++代码如下：</p>
<pre class="line-numbers language-c++"><code class="language-c++">#include <vector>
#include <iostream>
#include <algorithm>
#include <opencv2\opencv.hpp>
#include <opencv2\highgui\highgui.hpp>

using namespace std;
using namespace cv;

class ImageCrypto {
private:

    vector<int> random_sequence(int length, int seed) {
        vector<int> seq = vector<int>(length);
        for(int i = 0; i < length; i++) {
            seq[i] = i;
        }

        srand(seed);
        random_shuffle(seq.begin(), seq.end());
        return seq;
    }
public:

    Mat encrypt(Mat a, int seed) {
        int length = a.rows * a.cols * 3;
        vector<int> seq = random_sequence(length, seed);

        Mat b = a.clone();
        int cur = 0;
        for(int i = 0; i < a.rows; i++) {
            for(int j = 0; j < a.cols; j++) {
                const Vec3b& pixel = a.at<Vec3b>(i, j);
                *(b.data + seq[cur++]) = pixel[0];
                *(b.data + seq[cur++]) = pixel[1];
                *(b.data + seq[cur++]) = pixel[2];
            }
        }
        return b;
    }

    Mat decrypt(Mat a, int seed) {
        int length = a.rows * a.cols * 3;
        vector<int> seq = random_sequence(length, seed);

        Mat b = a.clone();
        int cur = 0;
        for(int i = 0; i < a.rows; i++) {
            for(int j = 0; j < a.cols; j++) {
                Vec3b & pixel = b.at<Vec3b>(i, j);
                pixel[0] = *(a.data + seq[cur++]);
                pixel[1] = *(a.data + seq[cur++]);
                pixel[2] = *(a.data + seq[cur++]);
            }
        }
        return b;

    }

};


void save_image(Mat img, char * imgPath) {

    vector<int> compression_params;
    compression_params.push_back(CV_IMWRITE_JPEG_QUALITY);  //选择jpeg
    compression_params.push_back(100);
    compression_params.push_back(CV_IMWRITE_PNG_COMPRESSION);
    compression_params.push_back(9);

    imwrite(imgPath, img, compression_params);
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>效果如下：</p>
<p>原图：<br><img src="./images/xiaoyang.jpg" alt="xiaoyang.jpg"><br>加密:<br><img src="./images/encrypt.jpg" alt="encrypt.jpg"><br>解密:<br><img src="./images/decrypt.jpg" alt="decrypt.jpg"></p>
<h4 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h4><p><a href="https://blog.csdn.net/xfgryujk/article/details/81058247" target="_blank" rel="noopener">写一个微博上传图片自动加密解密工具</a><br><a href="https://www.cnblogs.com/LoganChen/p/8586310.html" target="_blank" rel="noopener">关于Java中hashCode方法的实现源码</a></p>
</p></div><div class="share"><span>Share</span>&nbsp;<span class="soc"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></span><span class="soc"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f=' target="_blank" rel="noopener"http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></span><span class="soc"><a href="http://twitter.com/home?status=https://2yo.cc/2020/03/19/基于块随机置乱的图像加解密/%202YO' target="_blank" rel="noopener"s BLOG%20基于块随机置乱的图像加解密" class="fa fa-twitter"></a></span></div><div class="pagination"><p class="clearfix"><span class="pre pagbuttons"><a role="navigation" href="/2020/03/20/%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0%E5%BC%B9%E5%B9%95%E8%92%99%E7%89%88/" title="动手实现弹幕蒙版"><i class="fa fa-angle-double-left"></i>&nbsp;Previous post: 动手实现弹幕蒙版</a></span><span>&nbsp;</span><span class="next pagbuttons"><a role="navigation" href="/2020/03/09/%E4%B8%80%E4%B8%AA%E4%B8%8B%E8%BD%BDLive2d%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%B0%8F%E5%B7%A5%E5%85%B7/" title="一个下载Live2d模型的小工具">Next post: 一个下载Live2d模型的小工具&nbsp;<i class="fa fa-angle-double-right"></i></a></span></p></div><div id="lv-container" data-id="city" data-uid="MTAyMC80NjA5My8yMjYwNA=="><script type="text/javascript">(function (d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') {
        return;
    }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script><noscript> Please activate JavaScript for write a comment in LiveRe</noscript></div></div></div></div><div class="visible-xs site-bottom-footer"><footer><p>&copy;&nbsp;2020&nbsp;<a target="_blank" href="https://2yo.cc" rel="noopener noreferrer">2YO</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p><p><script type="text/javascript" src="https://v1.cnzz.com/z_stat.php?id=1278669758&web_id=1278669758"></script></p></footer></div></div></div></div><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/google-analytics.js"></script><script src="/js/typography.js"></script></body></html>